pico-8 cartridge // http://www.pico-8.com
version 41
__lua__

-- scream test
-- schoblaska

function _init()
  player = {
    x = 6, y = 8,
    moving_to = { x = 6, y = 8 },
    progress = 8,
    sprites = { 17, 18, 19 },
    frame = 0,
    flip = false,
    anim_speed = 30
  }

  enemy = {
    x = 9, y = 7,
    moving_to = { x = 9, y = 7 },
    progress = 8,
    sprites = { 33, 34 },
    frame = 0,
    flip = false,
    anim_speed = 40
  }

  entities = { player, enemy }
  enemy_speed = 0.25
  update_func = wait_for_player_input
end

function _update60()
  update_func()

  for entity in all(entities) do
    update_entity(entity)
  end
end

function _draw()
  for x = 0, 15 do
    for y = 0, 15 do
      local sprite = mget(x, y)
      spr(sprite, x * 8, y * 8)
    end
  end

  for entity in all(entities) do
    draw_entity(entity)
  end
end

function wait_for_player_input()
  if btnp(0) then
    if can_move(player, player.x - 1, player.y) then
      initiate_player_move(player.x - 1, player.y)
    end

    player.flip = false
  elseif btnp(1) then
    if can_move(player, player.x + 1, player.y) then
      initiate_player_move(player.x + 1, player.y)
    end

    player.flip = true
  elseif btnp(2) and can_move(player, player.x, player.y - 1) then
    initiate_player_move(player.x, player.y - 1)
  elseif btnp(3) and can_move(player, player.x, player.y + 1) then
    initiate_player_move(player.x, player.y + 1)
  end
end

function perform_player_movement()
  if player.progress < 6 then
    player.progress += 2
  else
    player.x = player.moving_to.x
    player.y = player.moving_to.y
    player.progress = 8
    update_func = wait_for_player_input
  end
end

function can_move(entity, x, y)
  local msprite = mget(x, y)

  if fget(msprite, 0) then
    return false
  end

  for entity in all(entities) do
    if entity.x == x and entity.y == y then
      return false
    end
  end

  return true
end

function initiate_player_move(x, y)
  player.moving_to = { x = x, y = y }
  player.progress = 1
  update_func = perform_player_movement
end

function draw_entity(entity)
  local sprite = entity.sprites[flr(entity.frame / entity.anim_speed) + 1]

  local offset_x = (entity.moving_to.x - entity.x) * entity.progress
  local offset_y = (entity.moving_to.y - entity.y) * entity.progress

  spr(sprite, entity.x * 8 + offset_x, entity.y * 8 + offset_y, 1, 1, entity.flip)
end

function update_entity(entity)
  if entity.frame >= entity.anim_speed * #entity.sprites - 1 then
    entity.frame = 0
  else
    entity.frame += 1
  end

  -- if entity ~= player and entity.x == entity.moving_to.x then
  --   if can_move(entity, entity.x - 1, entity.y) then
  --     entity.moving_to = { x = x, y = y }
  --     entity.progress = 1
  --   end
  -- end
end

__gfx__
0000000055555555666666d600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000055555555666666d600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070055555555dddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770005555555566d6666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770005555555566d6666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070055555555dddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555556666d66600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555556666d66600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000a0a00000a0a00000a0a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000bbbbba00bbbbba00bbbbba0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b1b1bbb0b1b1bbb0b1b1bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b1b1bbbab1b1bbbab1b1bbea000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbb1b0bbbbb1b0bbbbbeb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000001111beb01111ebb01111bbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b777bbbbe777bbbbe77ebbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ee7eebb0e7eebbb0be77ebb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000777000007770700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000077777770777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000722277707222777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000082827700828277000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000002222700e222270000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000e700e70707007e7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000777777c077777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cc77cc700c7cc70700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202010202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201020202010101010101020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010202010201010202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201020201010102010202010102020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201020201010102010202020102020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201020101010101010101010101020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020101010101010101010101020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020201010101020202020201020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020101010202020101020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020101020201010101010102020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020101020101020201020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020201010102020201010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020201020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
